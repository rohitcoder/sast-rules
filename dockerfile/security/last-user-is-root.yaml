rules:
- id: last-user-is-root__oxcyt
  languages:
  - dockerfile
  message: The last user in the container is 'root'. This is a security hazard because
    if an attacker gains control of the container they will have root access. Switch
    back to another user after running commands as 'root'.
  metadata:
    category: security
    confidence: MEDIUM
    cwe:
    - 'CWE-269: Improper Privilege Management'
    impact: MEDIUM
    likelihood: MEDIUM
    owasp:
    - A04:2021 - Insecure Design
    references:
    - https://github.com/hadolint/hadolint/wiki/DL3002
    source-rule-url: https://github.com/hadolint/hadolint/wiki/DL3002
    subcategory:
    - audit
    technology:
    - dockerfile
  patterns:
  - pattern-inside: 'USER $F

      ...

      USER $X

      '
  - pattern-not-inside: '...

      USER $X

      ...

      USER $F

      '
  - focus-metavariable: $X
  - metavariable-regex:
      metavariable: $X
      regex: ^(root)$
  - metavariable-regex:
      metavariable: $F
      regex: (.*(?!root))
  severity: ERROR
